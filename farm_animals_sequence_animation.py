#!/usr/bin/env python3
"""
Farm Animals Sequence Animation for LED Board
Displays cow, sheep, rooster, and duck in sequence, each for 6 seconds
"""

import time
from led_controller_exact import LEDControllerExact
import config

class FarmAnimalsSequenceAnimation:
    def __init__(self):
        """Initialize the farm animals sequence animation."""
        self.led = LEDControllerExact()
        self.width = config.TOTAL_WIDTH  # 32
        self.height = config.TOTAL_HEIGHT  # 48
        
        print(f"Display dimensions: {self.width}x{self.height}")
        
        # Animal bitmap data (32x48 pixels each)
        # Format: 0x00 = background, non-zero = animal pixel
        
        # Cow bitmap
        cow_bitmap = [
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x60, 0x0c, 0x00, 0x00, 0x60, 0x0e, 0x00, 0x00, 0xe0,
            0x0f, 0xff, 0xff, 0xe0, 0x0f, 0xff, 0xff, 0xe0, 0x06, 0x3c, 0x78, 0xc0, 0x07, 0x70, 0x1d, 0xc0,
            0x0f, 0xe0, 0x0f, 0xe0, 0x0f, 0xc0, 0x07, 0xe0, 0x0c, 0xc0, 0x06, 0x60, 0x06, 0xc0, 0x03, 0x60,
            0x07, 0x98, 0x33, 0xc0, 0x03, 0x98, 0x33, 0x80, 0x00, 0x80, 0x03, 0x00, 0x00, 0xc0, 0x03, 0x00,
            0x00, 0xc7, 0xc6, 0x00, 0x00, 0xff, 0xf6, 0x00, 0x00, 0x78, 0x3c, 0x00, 0x00, 0x30, 0x1c, 0x00,
            0x00, 0x66, 0x4c, 0x00, 0x00, 0x66, 0x4c, 0x00, 0x00, 0x66, 0x4c, 0x00, 0x00, 0x60, 0x0c, 0x00,
            0x00, 0x70, 0x1c, 0x00, 0x00, 0x3f, 0xf8, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ]
        
        # Sheep bitmap
        sheep_bitmap = [
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x00,
            0x00, 0x3f, 0xfc, 0x00, 0x00, 0x22, 0x4c, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x01, 0x80, 0x01, 0x80,
            0x01, 0x00, 0x00, 0x80, 0x1f, 0x00, 0x00, 0xf0, 0x1f, 0xa0, 0x01, 0xf8, 0x18, 0xe0, 0x07, 0x18,
            0x18, 0xf6, 0x6f, 0x18, 0x08, 0xff, 0xff, 0x10, 0x0f, 0x80, 0x03, 0xf0, 0x07, 0x80, 0x03, 0xe0,
            0x00, 0x84, 0x23, 0x00, 0x00, 0x84, 0x23, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0xc0, 0x03, 0x00,
            0x00, 0xc0, 0x03, 0x00, 0x00, 0xc0, 0x03, 0x00, 0x00, 0x42, 0x42, 0x00, 0x00, 0x63, 0xc6, 0x00,
            0x00, 0x31, 0x8c, 0x00, 0x00, 0x39, 0x9c, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x07, 0xe0, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ]
        
        # Rooster bitmap
        rooster_bitmap = [
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0,
            0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x03, 0xfc,
            0x00, 0x00, 0x07, 0xf8, 0x0f, 0xe0, 0x0f, 0xf8, 0x1f, 0xf0, 0x0f, 0xf8, 0x1f, 0xf8, 0x1f, 0xe0,
            0x3f, 0xfc, 0x3f, 0xe0, 0x3f, 0xfe, 0xff, 0xe0, 0x3f, 0xfd, 0xff, 0xe0, 0x3f, 0xfd, 0xfd, 0xe0,
            0x3f, 0xfb, 0xfb, 0xe0, 0x1f, 0xe7, 0xf7, 0xe0, 0x1f, 0xf1, 0xe7, 0xc0, 0x07, 0xff, 0x1f, 0xc0,
            0x03, 0xff, 0xff, 0xc0, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x3f, 0xff, 0x00, 0x00, 0x1f, 0xff, 0x00,
            0x00, 0x0f, 0xfe, 0x00, 0x00, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00,
            0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ]
        
        # Duck bitmap
        duck_bitmap = [
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x0f, 0x80,
            0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x1f, 0x70, 0x00, 0x00, 0x1f, 0x00,
            0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x0f, 0x80,
            0x00, 0x01, 0xf7, 0x80, 0x08, 0xc7, 0xef, 0x80, 0x0c, 0xef, 0xdf, 0xc0, 0x0e, 0xf0, 0x3f, 0xc0,
            0x07, 0x7f, 0xff, 0xc0, 0x07, 0xbf, 0xff, 0xc0, 0x01, 0xbf, 0xff, 0xc0, 0x03, 0xaf, 0xff, 0xc0,
            0x03, 0xb0, 0x7f, 0x80, 0x03, 0xf7, 0xff, 0x80, 0x03, 0xd7, 0xff, 0x00, 0x01, 0xe9, 0xde, 0x00,
            0x00, 0xff, 0xfc, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x0f, 0x88, 0x00, 0x00, 0x00, 0x08, 0x00,
            0x00, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ]
        
        # Convert all bitmaps to pixel arrays
        self.animals = []
        animal_names = ["Cow", "Sheep", "Rooster", "Duck"]
        animal_bitmaps = [cow_bitmap, sheep_bitmap, rooster_bitmap, duck_bitmap]
        animal_colors = [
            (139, 69, 19),   # Brown cow
            (255, 255, 255), # White sheep
            (255, 140, 0),   # Orange rooster
            (255, 200, 0)    # Yellow duck
        ]
        
        for name, bitmap, color in zip(animal_names, animal_bitmaps, animal_colors):
            pixels = self.bitmap_to_pixels(bitmap)
            self.animals.append({
                'name': name,
                'pixels': pixels,
                'color': color
            })
            print(f"Loaded {name} bitmap")
    
    def bitmap_to_pixels(self, bitmap_hex):
        """Convert bitmap hex array to pixel array.
        
        Args:
            bitmap_hex: List of hex values representing 32x48 bitmap
            
        Returns:
            2D array (48 rows x 32 cols) where 1 = animal pixel, 0 = background
        """
        pixels = []
        for row in range(48):
            row_data = []
            byte_start = row * 4
            for col in range(32):
                byte_index = byte_start + (col // 8)
                bit_index = 7 - (col % 8)
                byte_value = bitmap_hex[byte_index]
                pixel_bit = (byte_value >> bit_index) & 1
                # If bit is 1, it's an animal pixel
                row_data.append(pixel_bit)
            pixels.append(row_data)
        return pixels
    
    def safe_set_pixel(self, x, y, color):
        """Safely set a pixel if coordinates are within bounds."""
        if 0 <= x < self.width and 0 <= y < self.height:
            self.led.set_pixel(x, y, color)
    
    def draw_animal(self, animal_data):
        """Draw an animal bitmap on the display.
        
        Args:
            animal_data: Dictionary with 'name', 'pixels', and 'color'
        """
        self.led.clear()
        
        pixels = animal_data['pixels']
        color = animal_data['color']
        
        # Draw animal pixels
        for y in range(48):
            for x in range(32):
                if pixels[y][x] == 1:
                    self.safe_set_pixel(x, y, color)
        
        self.led.show()
    
    def run_animation(self, should_stop=None):
        """Run the farm animals sequence animation.
        Each animal displays for 6 seconds.
        
        Args:
            should_stop: Optional callback function that returns True if animation should stop.
        """
        duration_per_animal = 6  # 6 seconds per animal
        total_duration = len(self.animals) * duration_per_animal  # 24 seconds total
        
        start_time = time.time()
        
        print("Starting farm animals sequence animation...")
        print(f"Total duration: {total_duration} seconds")
        print(f"Each animal displays for {duration_per_animal} seconds")
        
        animal_index = -1  # Start at -1 so first animal is shown immediately
        last_animal_index = -1
        
        while time.time() - start_time < total_duration:
            # Check stop flag
            if should_stop and should_stop():
                print("Farm animals animation stopped by user")
                break
            
            # Calculate which animal to show based on elapsed time
            elapsed = time.time() - start_time
            animal_index = int(elapsed / duration_per_animal) % len(self.animals)
            
            # Draw current animal
            animal = self.animals[animal_index]
            self.draw_animal(animal)
            
            # Print when switching to a new animal
            if animal_index != last_animal_index:
                print(f"Showing {animal['name']} ({animal_index + 1}/{len(self.animals)}) - {duration_per_animal} seconds")
                last_animal_index = animal_index
            
            time.sleep(0.1)  # Update 10 times per second
        
        print("Farm animals sequence animation completed!")
        
        # Clear display
        self.led.clear()
        self.led.show()
    
    def cleanup(self):
        """Clean up resources."""
        self.led.cleanup()

def main():
    """Main function to run farm animals sequence animation."""
    try:
        animation = FarmAnimalsSequenceAnimation()
        animation.run_animation()
        animation.cleanup()
        
    except KeyboardInterrupt:
        print("\nAnimation interrupted by user")
        if 'animation' in locals():
            animation.cleanup()
    except Exception as e:
        print(f"Error: {e}")
        import traceback
        traceback.print_exc()
        if 'animation' in locals():
            animation.cleanup()

if __name__ == "__main__":
    main()

